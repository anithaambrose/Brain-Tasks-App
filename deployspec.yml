version: 0.2

env:
  variables:
    REGION: "ap-south-1"
    CLUSTER_NAME: "mindtrack"

phases:
  pre_build:
    commands:
      #Updating Kubeconfig to access EKS cluster 
      - aws eks update-kubeconfig --region $REGION --name $CLUSTER_NAME
  
  build:
    commands:
      #fetching latest image URI from ECR.
      - IMAGE_URI=$(cat image.json | jq -r '.[0].imageUri')

      # Updating image in deployment manifest file.
      - sed -i "s|image: \"\"|image: \"$IMAGE_URI\"|g" deployment.yaml
      - kubectl apply -f deployment.yaml
      - kubectl apply -f service.yaml

